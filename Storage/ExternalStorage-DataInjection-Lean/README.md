# Summary
Apps that read files stored in External Storage are vulnerable to malicious data injection attacks.

# Versions of Android affected
Tested on Android 4.4 - 6.0

# Description of the vulnerability and the corresponding exploit
Android allows apps to save data in files. These files can be stored in *Internal Storage* or in *External Storage*. Files stored in *Internal Storage* are private to the app. *External Storage* is divided into two regions -

  1. a shared storage directory, which can be accessed by all apps. However, apps will need to request the user for permission to access *ExternalStorage* before accessing the shared directory.  
  2. a private storage directory for each app. An app does not need any permissions to access its own private storage directory. However, other apps can get access to this directory if they have permission to access *ExternalStorage*.

*Issue* : If an app reads from any file stored in *ExternalStorage*, even if the file is in the private storage directory, then the app has no control over the file it is reading. If a malicious app changes the file the app is reading, the app will unknowingly read malicious content.

*Example* : The vulnerability is demonstrated by two apps, *Benign* - a benign app that installs *apk* files from the app's private storage directory, and *Malicious* - a malicious app that has write permission to *ExternalStorage* and injects apk files to *Benign's* private storage directory. The benign app's *Benign/.../MainActivity* starts a service in the background, *Benign/.../InstallApkIntentService*, that uses the API method *getExternalFilesDir()* to get a handle to the root of *Benign's* private storage directory. *InstallApkIntentService* then installs *bible.apk*. The malicious app *Malicious* modifies *bible.apk* and saves it in *Benign's* private storage directory. When *Benign* runs again, it will install the malicious *bible.apk*.    

*Note for Android 7.0* : In Android 7.0 and later the example described above will not work because it will throw a *FileUriExposedException*. This exception is raised because from Android 7.0, it is not possible to directly share a file path with another app. In this example, we are directly sharing the path of the apk that needs to be installed with the *PackageManager* app, which is responsible for installing the app in the device or emulator. To prevent the exception from being raised, one has to create a FileProvider (a default implementation of a content provider used to enable file sharing) for the private storage directory of *Benign*, create a *content:// uri* for the files in the private storage directory and grant the *PackageManager* app temporary permission to access the content uri.

# Steps to build the sample apps and to exploit the vulnerability

1. List targets:

    `$ android list targets`

2. List available Android Virtual Devices:

    `$ android list avd`

3. Create an emulator:

    `$ android create avd -n <name> -t <target>`

    *<target>* is obtained from the command listed in 1. *<name>* is the name you choose to give to the avd.

4. Start emulator:

    `$ emulator -avd <avd_name>`

    *<avd-name>* is obtained from the command listed in 2.


5. Build and install *Benign*:

    `$ cd Benign`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk.

    `$ ./gradlew installDebug`

6. Build and install *Malicious*:

    `$ cd Malicious`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk.

    `$ ./gradlew installDebug`

7.  Launch *Malicious*. The app writes *bible.apk* into *Benign's* external private storage directory.

8.  You can verify by launching *Benign*. *Benign* reads apk files and installs them. *bible.apk* should be installed successfully.

# References

1.  [Android Official Documentation](https://developer.android.com/guide/topics/data/data-storage.html#filesExternal)
