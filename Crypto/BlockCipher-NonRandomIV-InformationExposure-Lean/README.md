# Summary
Apps that use a block cipher algorithm in CBC mode  with a non random Initialization Vector to encrypt sensitive information are vulnerable to leaking sensitive information.

# Versions of Android affected
Tested on Android 4.4 - Android 7.1

# Description of the vulnerability and the corresponding exploit
Android apps can use block cipher algorithms to encrypt sensitive information. The *Cipher* API enables developers to specify which block cipher algorithm to use and in which mode.

*Issue:* If the app uses the block cipher algorithm *AES* in *CBC* mode then it needs to provide an Initialization Vector (IV) which will be *XOR-ed* with the information that needs to be encrypted. If the provided IV is not random then encrypting a particular piece of information with a symmetric key will yield the same result every time encryption is applied to that information with the same symmetric key. An attacker with access to the encrypted information can then infer the actual information by just analyzing and comparing the encrypted results.

*Example:* This vulnerability is demonstrated by the pair of apps *Benign* and *Malicious*. *Benign* has an *exported* content provider *GradesContentProvider* that provides two methods *insert* to save student name and student grade in encrypted form and *query* to retrieve the list of encrypted student name and student grade. Let us assume that an attacker knows the names of all students saved in *Benign's* storage and all student have unique names. The attacker's goal is to determine the grade of a particular student X. The attacker uses *Malicious* for this. The attacker guesses a grade for X and from *Malicious* calls *GradesContentProvider.insert(X~name~, X~grade~)*. The attacker then calls *GradesContentProvider.query()* to retrieve the list of encrypted *(name,grade)*. In this list the attacker looks for duplicate entries. If it finds one it will know that the guessed grade is correct if not it tries again with a new guess.     

*Note: This benchmark also uses a constant key embedded statically in the source code of Benign. This is also a security vulnerability since anyone with access to the source code can extract the secret key from it.*

# Steps to build the sample apps and to exploit the vulnerability

1. List targets:

    `$ android list targets`

2. List available Android Virtual Devices:

    `$ android list avd`

3. Create an emulator:

    `$ android create avd -n <name> -t <target>`

    *target* is obtained from the command listed in 1. *name* is the name you choose to give to the avd.

4. Start emulator:

    `$ emulator -avd <avd_name>`

    *avd-name* is obtained from the command listed in 2.

5. Build and install Benign:

    `$ cd Benign`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk.

    `$ ./gradlew installDebug`

6. Build and install Malicious:

    `$ cd Malicious`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk.

    `$ ./gradlew installDebug`

7. Open *Benign* in the emulator where you installed the app.

8. Click on *Add Student* to add a student and her grade.

8.  Open *Malicious* in the emulator where you installed the app.

9.  In *Malicious* enter the same *Student Name* and *Grade* you used in 8.

10. Click *Verify*. You will see a message *"Congratulations! you guessed the right grade"*.

11. You can also check the log to see the list of encrypted values. If you find duplicate entries you will know that your guess was right.

    `$ adb logcat -d | grep "Malicious"`

# References

1. [An Empirical study of Crypto API misuse in Android apps](http://dl.acm.org/citation.cfm?id=2516693)

2. [Official Android Documentation](https://developer.android.com/reference/javax/crypto/Cipher.html)
